import"./modulepreload-polyfill-B5Qt9EMX.js";const x="https://www.onemap.gov.sg/api";async function z(n,e){const r=await fetch(n,e);if(!r.ok){const o=await r.text().catch(()=>"");throw new Error(`${r.status} ${r.statusText}${o?` - ${o}`:""}`)}return r.json()}function m(n){const e=String(n??"").trim();return!e||e.toUpperCase()==="NIL"?"":e}function h(n){const e=typeof n=="number"?n:Number(String(n).trim());return Number.isFinite(e)?e:null}function I(n){const e=String(n??"").trim();return e?e.replace(/^bearer\s+/i,"").trim():""}async function H({email:n,password:e}){if(!n||!e)throw new Error("缺少 email 或 password");return z(`${x}/auth/post/getToken`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,password:e})})}function J(n){const e=String(n??"").trim();if(!e)return null;const o=e.replace(/^bearer\s+/i,"").trim().split(".");if(o.length<2)return null;try{const i=o[1].replace(/-/g,"+").replace(/_/g,"/"),d=i+"=".repeat((4-i.length%4)%4),p=JSON.parse(atob(d)),b=Number(p==null?void 0:p.exp);return Number.isFinite(b)?b*1e3:null}catch{return null}}function B({lat:n,lng:e,buffer:r=50,addressType:o="All"}){const i=h(n),d=h(e);if(i==null||d==null)throw new Error("lat/lng 必须是有效数字");return`https://www.onemap.gov.sg/api/public/revgeocode?${new URLSearchParams({location:`${i},${d}`,buffer:String(r),addressType:String(o)}).toString()}`}function _(n){const e=m(n==null?void 0:n.BUILDINGNAME),r=m(n==null?void 0:n.BLOCK),o=m(n==null?void 0:n.ROAD),i=m(n==null?void 0:n.POSTALCODE);return[e,[r,o].filter(Boolean).join(" "),i].filter(Boolean).join(" ")}async function j({lat:n,lng:e,buffer:r=50,addressType:o="All",token:i}={}){const d=I(i);if(!d)throw new Error("Unauthorized：此接口目前需要 token。请先按 Get Token 或到 demo/auth-token.html 取得 access_token。");const p=B({lat:n,lng:e,buffer:r,addressType:o}),b={Authorization:`Bearer ${d}`},g=await fetch(p,{headers:b});if(g.status===401)throw new Error("Unauthorized：token 无效或已过期，请重新取得 token。");if(!g.ok)throw new Error(`OneMap revgeocode 失败（${g.status}）`);const v=await g.json(),y=Array.isArray(v==null?void 0:v.GeocodeInfo)?v.GeocodeInfo:[],w=y[0]||null;return{url:p,raw:v,geocodeInfo:y,best:w,fullAddress:w?_(w):""}}function P(n){return n.map(e=>{const r=m(e==null?void 0:e.BUILDINGNAME),o=m(e==null?void 0:e.BLOCK),i=m(e==null?void 0:e.ROAD),d=m(e==null?void 0:e.POSTALCODE);return{buildingName:r,block:o,road:i,postalCode:d,x:(e==null?void 0:e.XCOORD)??"",y:(e==null?void 0:e.YCOORD)??"",latitude:(e==null?void 0:e.LATITUDE)??"",longitude:(e==null?void 0:e.LONGITUDE)??"",fullAddress:[r,o,i,d].filter(Boolean).join(" ")}})}function F({url:n,token:e}){const r=I(e);return r?`curl -s "${n}" -H "Authorization: Bearer ${r}"`:`curl -s "${n}"`}const K="flowchart TD\\n  U[输入 lat/lng 或 Combined] --> V[解析 + 验证]\\n  V --> R[GET /api/public/revgeocode]\\n  R --> L[GeocodeInfo[] 候选列表]\\n  L --> B[best = GeocodeInfo[0]]\\n  B --> A[拼 fullAddress: BUILDING + BLK + ROAD + POSTAL]",X="function normalizeNil(value) {\\n  const text = String(value ?? '').trim();\\n  if (!text || text.toUpperCase() === 'NIL') return '';\\n  return text;\\n}\\n\\nfunction toNumber(value) {\\n  const num = typeof value === 'number' ? value : Number(String(value).trim());\\n  return Number.isFinite(num) ? num : null;\\n}\\n\\nfunction buildRevGeocodeUrl({ lat, lng, buffer = 50, addressType = 'All' }) {\\n  const latNum = toNumber(lat);\\n  const lngNum = toNumber(lng);\\n  if (latNum == null || lngNum == null) throw new Error('Invalid lat/lng');\\n  const params = new URLSearchParams({ location: `${latNum},${lngNum}`, buffer: String(buffer), addressType: String(addressType) });\\n  return `https://www.onemap.gov.sg/api/public/revgeocode?${params.toString()}`;\\n}\\n\\nfunction formatFullAddress(best) {\\n  const building = normalizeNil(best?.BUILDINGNAME);\\n  const block = normalizeNil(best?.BLOCK);\\n  const road = normalizeNil(best?.ROAD);\\n  const postal = normalizeNil(best?.POSTALCODE);\\n  return [building, [block, road].filter(Boolean).join(' '), postal].filter(Boolean).join(' ');\\n}\\n\\nasync function reverseGeocode({ lat, lng, buffer = 50, addressType = 'All', token } = {}) {\\n  const url = buildRevGeocodeUrl({ lat, lng, buffer, addressType });\\n  const headers = token ? { Authorization: `Bearer ${token.replace(/^bearer\\\\s+/i, '').trim()}` } : undefined;\\n  const res = await fetch(url, headers ? { headers } : undefined);\\n  if (!res.ok) throw new Error(`OneMap revgeocode failed (${res.status})`);\\n  const raw = await res.json();\\n  const geocodeInfo = Array.isArray(raw?.GeocodeInfo) ? raw.GeocodeInfo : [];\\n  const best = geocodeInfo[0] || null;\\n  return { url, raw, geocodeInfo, best, fullAddress: best ? formatFullAddress(best) : '' };\\n}";function V(){const n=s=>document.getElementById(s),e={combined:n("combined"),email:n("email"),lat:n("lat"),lng:n("lng"),buffer:n("buffer"),addressType:n("addressType"),password:n("password"),token:n("token"),btnLogin:n("btnLogin"),btnLookup:n("btnLookup"),btnClear:n("btnClear"),btnCopyCurl:n("btnCopyCurl"),btnCopyJson:n("btnCopyJson"),btnCopyHelper:n("btnCopyHelper"),btnCopyUsage:n("btnCopyUsage"),btnCopyMermaid:n("btnCopyMermaid"),status:n("status"),tokenStatus:n("tokenStatus"),results:n("results"),raw:n("raw"),toast:n("toast"),helper:n("helper"),mermaid:n("mermaid")};let r=!1;function o(s){return String(s).replace(/[&<>"']/g,l=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[l])}function i(s){e.toast.textContent=s?`提示：${s}`:""}function d(s){e.btnLogin.disabled=s,e.btnLookup.disabled=s,e.btnClear.disabled=s,e.btnCopyCurl.disabled=s}function p(s,l){const a=l==="ok"?"ok":l==="bad"?"bad":"";e.status.innerHTML=`<b>Status</b><span class="${a}">${o(s)}</span>`}function b(s){if(!e.token.value.trim()){e.tokenStatus.innerHTML="<b>Token</b><span>未取得</span>";return}const a=s?`有效（到期：${s}）`:"已设置";e.tokenStatus.innerHTML=`<b class="ok">Token</b><span>${o(a)}</span>`}function g(){e.results.innerHTML='<div class="resultItem"><div class="addr">输入坐标后点击 Reverse Geocode</div><div class="meta">会显示 GeocodeInfo 候选列表，以及 best（第一笔）</div></div>'}function v({url:s,list:l}){if(!l.length){e.results.innerHTML=`<div class="resultItem"><div class="addr">0 结果</div><div class="meta">建议调整 buffer 或检查 lat/lng（WGS84）</div></div><div class="resultItem"><div class="addr">请求 URL</div><div class="meta">${o(s)}</div></div>`;return}const a=l[0],S=a.latitude&&a.longitude?`https://www.onemap.gov.sg/main/v2/?lat=${encodeURIComponent(a.latitude)}&lng=${encodeURIComponent(a.longitude)}`:"",E=[`fullAddress=${a.fullAddress}`,a.buildingName&&`BUILDING=${a.buildingName}`,a.block&&`BLK=${a.block}`,a.road&&`ROAD=${a.road}`,a.postalCode&&`POSTAL=${a.postalCode}`,a.x&&`X=${a.x}`,a.y&&`Y=${a.y}`,a.latitude&&`Lat=${a.latitude}`,a.longitude&&`Lng=${a.longitude}`,S&&`OneMap=${S}`].filter(Boolean).join(`
`),L=l.map((u,U)=>{const D=[u.buildingName&&`BUILDING=${u.buildingName}`,u.block&&`BLK=${u.block}`,u.road&&`ROAD=${u.road}`,u.postalCode&&`POSTAL=${u.postalCode}`,u.x&&`X=${u.x}`,u.y&&`Y=${u.y}`,u.latitude&&`Lat=${u.latitude}`,u.longitude&&`Lng=${u.longitude}`].filter(Boolean).join(" · "),M=`${U+1}. ${u.fullAddress||"(Address N/A)"}`;return`<div class="resultItem"><div class="addr">${o(M)}</div><div class="meta">${o(D)}</div></div>`}).join("");e.results.innerHTML=`<div class="resultItem"><div class="addr">best（默认取第 1 笔）</div><div class="meta">${o(E)}</div></div><div class="resultItem"><div class="addr">请求 URL</div><div class="meta">${o(s)}</div></div>`+L}function y(){if(r)return;r=!0;const s=e.lat.value.trim(),l=e.lng.value.trim();e.combined.value=s&&l?`${s}, ${l}`:"",r=!1}function w(){if(r)return;r=!0;const s=e.combined.value.trim();if(!s)e.lat.value="",e.lng.value="";else{const l=s.split(/[,\s]+/).map(a=>a.trim()).filter(Boolean);l.length>=2&&(e.lat.value=l[0],e.lng.value=l[1])}r=!1}function O(){let s=e.lat.value.trim(),l=e.lng.value.trim();if(!s||!l){const E=e.combined.value.trim();if(E){const L=E.split(/[,\s]+/).map(u=>u.trim()).filter(Boolean);L.length>=2&&(s=L[0],l=L[1],e.lat.value=s,e.lng.value=l)}}const a=Number(s),S=Number(l);if(!Number.isFinite(a)||!Number.isFinite(S))throw new Error("请填写有效的 lat/lng（数字）");return{email:e.email.value.trim(),password:e.password.value,lat:a,lng:S,buffer:Number(e.buffer.value)||50,addressType:e.addressType.value||"All",token:e.token.value.trim()}}function R(){e.lat.addEventListener("input",y),e.lng.addEventListener("input",y),e.combined.addEventListener("input",w)}function G(){e.lat.value="1.3521",e.lng.value="103.8198",y()}return{el:e,bindSyncHandlers:R,getInput:O,renderEmpty:g,renderResults:v,renderTokenStatus:b,setBusy:d,setDefaults:G,setStatus:p,setToast:i}}const t=V();let T=null,f="",c=null,k=!1;async function N(n){await navigator.clipboard.writeText(n),t.setToast("已复制到剪贴板")}function C(){return c?Date.now()<c-6e4:!0}async function $(n,e){const r=t.el.token.value.trim();if(r&&C())return r;if(r&&!C()&&(t.el.token.value="",f="",c=null,t.renderTokenStatus(f)),!n||!e)throw new Error("需要先填写 OneMap Email/Password 才能自动取得 token。");const o=await H({email:n,password:e}),i=(o==null?void 0:o.access_token)??"";return t.el.token.value=i,c=o!=null&&o.expiry_timestamp?new Date(o.expiry_timestamp).getTime():null,c||(c=J(i)),f=c?new Date(c).toLocaleString():"",t.renderTokenStatus(f),i}async function A(){const n=t.getInput(),e=await $(n.email,n.password),r=await j({...n,token:e});T=r.raw,t.el.raw.value=JSON.stringify(r.raw,null,2),t.el.btnCopyJson.disabled=!1,t.renderResults({url:r.url,list:P(r.geocodeInfo)})}t.bindSyncHandlers();t.el.btnCopyJson.disabled=!0;t.el.mermaid.value=K;t.el.helper.value=X;t.renderEmpty();t.setDefaults();t.renderTokenStatus(f);t.setStatus("等待查询…","neutral");t.el.btnLogin.addEventListener("click",async()=>{try{t.setToast(""),t.setBusy(!0),t.setStatus("取得 token 中…","neutral");const n=t.getInput();await $(n.email,n.password),k=!1,t.setStatus("Token 已取得","ok")}catch(n){const e=n instanceof Error?n.message:String(n);t.el.token.value="",f="",c=null,k=!1,t.renderTokenStatus(f),t.setStatus(e,"bad")}finally{t.setBusy(!1)}});t.el.btnLookup.addEventListener("click",async()=>{try{t.setToast(""),t.setBusy(!0),t.setStatus("查询中…","neutral"),await A(),k=!1,t.setStatus("成功","ok")}catch(n){const e=n instanceof Error?n.message:String(n);if(!k&&/unauthorized/i.test(e)&&t.el.email.value.trim()&&t.el.password.value)try{k=!0,t.el.token.value="",f="",c=null,t.renderTokenStatus(f),await A(),t.setStatus("成功（已自动刷新 token）","ok");return}catch(o){const i=o instanceof Error?o.message:String(o);t.setStatus(i,"bad")}else t.setStatus(e,"bad");t.el.results.innerHTML=`<div class="resultItem"><div class="addr bad">错误</div><div class="meta">${e}</div></div>`,t.el.raw.value="",T=null,t.el.btnCopyJson.disabled=!0}finally{t.setBusy(!1)}});t.el.btnClear.addEventListener("click",()=>{t.el.token.value="",t.el.email.value="",t.el.password.value="",t.el.combined.value="",t.setDefaults(),t.el.raw.value="",T=null,t.el.btnCopyJson.disabled=!0,f="",c=null,k=!1,t.renderTokenStatus(f),t.renderEmpty(),t.setStatus("等待查询…","neutral"),t.setToast("")});t.el.btnCopyCurl.addEventListener("click",async()=>{const n=t.getInput(),e=await $(n.email,n.password),r=B(n);await N(F({url:r,token:e}))});t.el.btnCopyMermaid.addEventListener("click",async()=>N(t.el.mermaid.value.trim()));t.el.btnCopyHelper.addEventListener("click",async()=>N(t.el.helper.value.trim()));t.el.btnCopyUsage.addEventListener("click",async()=>{await N(["// Browser / Node 18+","const res = await reverseGeocode({ lat: 1.3521, lng: 103.8198, buffer: 50, addressType: 'All', token: '<access_token>' });","console.log(res.fullAddress, res.best);"].join(`
`))});t.el.btnCopyJson.addEventListener("click",async()=>{T&&await N(JSON.stringify(T,null,2))});
