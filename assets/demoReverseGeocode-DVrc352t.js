import"./modulepreload-polyfill-B5Qt9EMX.js";const I="https://www.onemap.gov.sg/api";async function k(n,e){const t=await fetch(n,e);if(!t.ok){const s=await t.text().catch(()=>"");throw new Error(`${t.status} ${t.statusText}${s?` - ${s}`:""}`)}return t.json()}async function x({email:n,password:e}){if(!n||!e)throw new Error("缺少 email 或 password");return k(`${I}/auth/post/getToken`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,password:e})})}async function H({lat:n,lng:e,token:t,buffer:s=50,addressType:d="All"}){if(!Number.isFinite(n)||!Number.isFinite(e))throw new Error("lat/lng 必須是數字");const i=`${I}/public/revgeocode?location=${encodeURIComponent(`${n},${e}`)}&buffer=${encodeURIComponent(s)}&addressType=${encodeURIComponent(d)}`,r=t?{Authorization:`Bearer ${t}`}:void 0;return k(i,{headers:r})}function M(n){return(Array.isArray(n==null?void 0:n.GeocodeInfo)?n.GeocodeInfo:[]).map(t=>{const s=v(t==null?void 0:t.BUILDINGNAME),d=v(t==null?void 0:t.BLOCK),i=v(t==null?void 0:t.ROAD),r=v(t==null?void 0:t.POSTALCODE);return{fullAddress:[s,d,i,r].filter(Boolean).join(" "),buildingName:s,block:d,road:i,postalCode:r,x:(t==null?void 0:t.XCOORD)??"",y:(t==null?void 0:t.YCOORD)??"",latitude:(t==null?void 0:t.LATITUDE)??"",longitude:(t==null?void 0:t.LONGITUDE)??""}})}function v(n){const e=String(n??"").trim();return!e||e.toUpperCase()==="NIL"?"":e}const N=document.getElementById("email"),C=document.getElementById("password"),l=document.getElementById("lat"),o=document.getElementById("lng"),f=document.getElementById("combined"),U=document.getElementById("buffer"),D=document.getElementById("addressType"),A=document.getElementById("btnLogin"),$=document.getElementById("btnLookup"),h=document.getElementById("btnClear"),c=document.getElementById("tokenStatus"),y=document.getElementById("results"),p=document.getElementById("raw");let a="",g="",u=!1;R();E();A.addEventListener("click",async()=>{try{b(!0);const n=N.value.trim(),e=C.value,t=await x({email:n,password:e});a=(t==null?void 0:t.access_token)??"",g=(t==null?void 0:t.expiry_timestamp)??"",E()}catch(n){a="",g="",S(n)}finally{b(!1)}});$.addEventListener("click",async()=>{try{b(!0);let n=l.value.trim(),e=o.value.trim();if(!n||!e){const w=f.value.trim();if(w){const L=w.split(/[,\s]+/).map(O=>O.trim()).filter(Boolean);L.length>=2&&(n=L[0],e=L[1],l.value=n,o.value=e)}}if(!n||!e)throw new Error("請輸入完整的經緯度座標（可使用 Combined 或分開輸入）");const t=Number(n),s=Number(e);if(!Number.isFinite(t)||!Number.isFinite(s))throw new Error("經緯度必須是有效的數字");const d=Number(U.value),i=D.value,r=await H({lat:t,lng:s,token:a,buffer:d,addressType:i}),T=M(r);F(T),p.innerHTML=P(r),p.style.display="block"}catch(n){S(n)}finally{b(!1)}});h.addEventListener("click",()=>{a="",g="",N.value="",C.value="",R(),y.innerHTML="",p.innerHTML="",p.style.display="none",E()});function B(){if(u)return;u=!0;const n=l.value.trim(),e=o.value.trim();n&&e?f.value=`${n}, ${e}`:f.value="",u=!1}function j(){if(u)return;u=!0;const n=f.value.trim();if(!n)l.value="",o.value="";else{const e=n.split(/[,\s]+/).map(t=>t.trim()).filter(Boolean);e.length>=2&&(l.value=e[0],o.value=e[1])}u=!1}l.addEventListener("input",B);o.addEventListener("input",B);f.addEventListener("input",j);function b(n){A.disabled=n,$.disabled=n||!a,h.disabled=n}function E(){$.disabled=!a,a?(c.classList.remove("bad"),c.classList.add("ok"),c.innerHTML=`<span>Token Status</span><b style="color: var(--ok)">Active (Expires: ${m(g?new Date(g).toLocaleTimeString():"Unknown")})</b>`):(c.classList.remove("ok"),c.classList.add("bad"),c.innerHTML='<span>Token Status</span><b style="color: var(--bad)">Not Retrieved</b>')}function F(n){if(!n.length){y.innerHTML='<div class="result-item"><div class="result-addr">No Results</div><div class="result-meta">Try adjusting coordinates or buffer</div></div>';return}y.innerHTML=n.map((e,t)=>{const s=[e.buildingName&&`Building=${e.buildingName}`,e.block&&`Blk=${e.block}`,e.road&&`Road=${e.road}`,e.postalCode&&`Postal=${e.postalCode}`,e.x&&`X=${e.x}`,e.y&&`Y=${e.y}`,e.latitude&&`Lat=${e.latitude}`,e.longitude&&`Lng=${e.longitude}`].filter(Boolean).join(" · ");return`
        <div class="result-item">
          <div class="result-addr">${m(`${t+1}. ${e.fullAddress||"(Address N/A)"}`)}</div>
          <div class="result-meta">${m(s)}</div>
        </div>
      `}).join("")}function S(n){const e=n instanceof Error?n.message:String(n);y.innerHTML=`<div class="result-item"><div class="result-addr" style="color: var(--bad)">Error Occurred</div><div class="result-meta">${m(e)}</div></div>`,p.textContent="",E()}function m(n){return String(n).replace(/[&<>"']/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return e}})}function R(){l.value="1.3521",o.value="103.8198",B()}function P(n){return typeof n!="string"&&(n=JSON.stringify(n,void 0,2)),n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),n.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){let t="json-number";return/^"/.test(e)?/:$/.test(e)?t="json-key":t="json-string":/true|false/.test(e)?t="json-boolean":/null/.test(e)&&(t="json-null"),'<span class="'+t+'">'+e+"</span>"})}
